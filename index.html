<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quittance de Loyer Officielle</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        :root { --main-color: #2c3e50; --accent-color: #3498db; --edit-color: #27ae60; --del-color: #e74c3c; }
        body { font-family: 'Segoe UI', Helvetica, Arial, sans-serif; background-color: #f4f7f6; color: #333; padding: 20px; }
        .app-container { max-width: 850px; margin: auto; }
        
        /* Interface de saisie */
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; border-top: 5px solid var(--accent-color); }
        h2 { margin-top: 0; font-size: 14px; color: var(--main-color); text-transform: uppercase; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        label { display: block; font-size: 11px; font-weight: bold; color: #7f8c8d; margin-bottom: 5px; text-transform: uppercase; }
        input { width: 100%; padding: 10px; border: 1px solid #dfe6e9; border-radius: 6px; box-sizing: border-box; font-size: 14px; outline-color: var(--accent-color); }
        .opt-box { display: flex; align-items: center; gap: 10px; background: #f9f9f9; padding: 10px; border-radius: 6px; margin-top: 10px; border: 1px solid #eee; cursor: pointer; }
        .btn-principal { background: var(--main-color); color: white; border: none; border-radius: 6px; padding: 15px; font-weight: bold; width: 100%; cursor: pointer; margin-top: 20px; text-transform: uppercase; transition: 0.3s; }

        /* Tableau registre */
        .hist-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .hist-table th { text-align: left; padding: 12px; background: #f8f9fa; color: #7f8c8d; }
        .hist-table td { padding: 12px; border-bottom: 1px solid #eee; }
        .action-link { cursor: pointer; font-weight: bold; font-size: 14px; margin-right: 8px; padding: 4px 8px; border-radius: 4px; border: 1px solid; display: inline-block; }
        .link-print { color: var(--accent-color); border-color: var(--accent-color); }
        .link-edit { color: var(--edit-color); border-color: var(--edit-color); }
        .link-del { color: var(--del-color); border-color: var(--del-color); }

        /* STYLE DU RE√áU */
        #recu-final { background: white; padding: 60px; display: none; margin-top: 30px; border: 1px solid #ddd; }
        .top-bar { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 3px solid var(--main-color); padding-bottom: 20px; margin-bottom: 40px; }
        .title-area h1 { margin: 0; font-size: 28px; color: var(--main-color); font-weight: 900; }
        .ref-no { color: var(--accent-color); font-weight: bold; margin-top: 5px; font-size: 18px; }
        .message-content { font-size: 18px; line-height: 1.8; color: #222; text-align: justify; }
        .valeur { color: #000; font-weight: bold; border-bottom: 1px dashed #999; padding: 0 4px; }
        .qr-container { display: flex; justify-content: center; margin: 30px 0; }
        .info-footer { margin-top: 40px; display: flex; justify-content: space-between; align-items: flex-start; }
        .sign-zone { text-align: center; border: 1px solid #333; width: 220px; height: 120px; display: flex; flex-direction: column; justify-content: space-between; padding: 10px; border-radius: 4px; }
        .sign-title { font-size: 12px; font-weight: bold; text-transform: uppercase; border-bottom: 1px solid #eee; padding-bottom: 5px; }

        /* CONFIGURATION IMPRESSION : ENLEVE LE LIEN DU FICHIER ET LA DATE */
        @media print {
            @page { margin: 1cm; }
            body { background: white; padding: 0; }
            .no-print { display: none !important; }
            #recu-final { display: block !important; border: none; padding: 20px; box-shadow: none; }
        }
    </style>
</head>
<body>

<div class="app-container">
    <div class="card no-print">
        <h2>Nouvelle Quittance</h2>
        <div style="margin-bottom: 20px;"><label>Logo / Tampon</label><input type="file" id="logoInput" accept="image/*" onchange="previewLogo(event)"></div>
        <div class="grid">
            <div><label>Bailleur</label><input type="text" id="proprio"></div>
            <div><label>Locataire</label><input type="text" id="locataire"></div>
        </div>
        <div class="opt-box" onclick="document.getElementById('checkRep').click()"><input type="checkbox" id="checkRep" onchange="toggleRep()" style="width:18px; height:18px;"><span style="font-size: 14px;">Utiliser un mandataire</span></div>
        <div id="divRep" style="display:none; margin-top:10px;"><label>Nom du Mandataire</label><input type="text" id="nomRep"></div>
        <div style="margin-top:15px;"><label>Adresse (Quartier)</label><input type="text" id="adresse"></div>
        <div class="grid" style="margin-top:15px;">
            <div><label>Loyer (GNF)</label><input type="number" id="montant"></div>
            <div><label>Mois & Ann√©e</label><input type="text" id="mois"></div>
        </div>
        <div class="opt-box" onclick="document.getElementById('checkCharges').click()"><input type="checkbox" id="checkCharges" style="width:18px; height:18px;"><span style="font-size: 14px;">Inclure les charges locatives</span></div>
        <button class="btn-principal" onclick="genererEtSauver()">G√©n√©rer la Quittance</button>
    </div>

    <div class="card no-print">
        <h2>Historique</h2>
        <table class="hist-table">
            <thead><tr><th>N¬∞</th><th>Date</th><th>Locataire</th><th>Actions</th></tr></thead>
            <tbody id="hist-body"></tbody>
        </table>
    </div>

    <div id="recu-final">
        <div class="top-bar">
            <div class="title-area">
                <h1>QUITTANCE DE LOYER</h1>
                <div class="ref-no">R√©f : <span id="res-num"></span></div>
            </div>
            <img id="logo-display" style="max-height: 90px; display:none;">
        </div>

        <div class="message-content">
            <p id="intro-phrase"></p>
            <p>Certifie avoir re√ßu de la part de <span class="valeur" id="res-locataire"></span>, la somme totale de <span class="valeur" id="res-montant"></span> au titre du r√®glement du <span id="res-label">loyer</span>.</p>
            <p>Ce paiement est aff√©rent √† la p√©riode d'occupation du mois de <span class="valeur" id="res-mois"></span>, pour les locaux situ√©s au quartier <span class="valeur" id="res-adresse"></span>, √† Conakry.</p>
            <p>Sous r√©serve de tous nos droits, la pr√©sente quittance est d√©livr√©e pour valoir ce que de droit, lib√©rant le locataire de sa dette locative pour la p√©riode susmentionn√©e.</p>
            <div class="qr-container"><div id="qrcode"></div></div>
        </div>

        <div class="info-footer">
            <div><p>Fait √† <strong>Conakry</strong>, le <span id="res-date" class="valeur"></span></p></div>
            <div class="sign-zone"><div class="sign-title">Le Bailleur ou Mandataire</div></div>
        </div>
        <button class="no-print btn-principal" style="background:#27ae60; margin-top:50px;" onclick="window.print()">IMPRIMER / SAUVEGARDER PDF</button>
    </div>
</div>

<script>
    let logoData = "";
    let historique = JSON.parse(localStorage.getItem('quittance_final_v2')) || [];
    window.onload = function() { afficherHistorique(); };

    function previewLogo(e) {
        const reader = new FileReader();
        reader.onload = () => { 
            logoData = reader.result; 
            document.getElementById('logo-display').src = logoData;
            document.getElementById('logo-display').style.display = 'block';
        };
        reader.readAsDataURL(e.target.files[0]);
    }

    function toggleRep() { document.getElementById('divRep').style.display = document.getElementById('checkRep').checked ? 'block' : 'none'; }

    function genererEtSauver() {
        let num = historique.length > 0 ? Math.max(...historique.map(h => h.num)) + 1 : 1;
        const data = {
            id: Date.now(), num: num, date: new Date().toLocaleDateString('fr-FR'),
            proprio: document.getElementById('proprio').value, locataire: document.getElementById('locataire').value,
            adresse: document.getElementById('adresse').value, mois: document.getElementById('mois').value,
            montant: document.getElementById('montant').value, rep: document.getElementById('nomRep').value,
            estRep: document.getElementById('checkRep').checked, charges: document.getElementById('checkCharges').checked
        };
        historique.push(data);
        localStorage.setItem('quittance_final_v2', JSON.stringify(historique));
        remplirRecu(data);
        afficherHistorique();
    }

    function remplirRecu(item) {
        const mntF = new Intl.NumberFormat('fr-FR').format(item.montant) + " GNF";
        const numF = "Q" + new Date().getFullYear() + "-" + item.num.toString().padStart(3, '0');
        document.getElementById('intro-phrase').innerHTML = item.estRep ? `Je soussign√©(e), <span class="valeur">${item.rep}</span>, agissant en qualit√© de mandataire pour le compte du bailleur, <span class="valeur">${item.proprio}</span>,` : `Je soussign√©(e), <span class="valeur">${item.proprio}</span>, en ma qualit√© de bailleur du logement d√©sign√© ci-apr√®s,`;
        document.getElementById('res-locataire').innerText = item.locataire;
        document.getElementById('res-montant').innerText = mntF;
        document.getElementById('res-mois').innerText = item.mois;
        document.getElementById('res-adresse').innerText = item.adresse;
        document.getElementById('res-date').innerText = item.date;
        document.getElementById('res-num').innerText = numF;
        document.getElementById('res-label').innerText = item.charges ? "loyer charges comprises" : "loyer principal";
        document.getElementById("qrcode").innerHTML = "";
        try { if(typeof QRCode !== "undefined") { new QRCode(document.getElementById("qrcode"), { text: "REF:" + numF + " | " + item.locataire, width: 90, height: 90 }); } } catch(e) {}
        document.getElementById('recu-final').style.display = 'block';
        window.scrollTo({ top: document.getElementById('recu-final').offsetTop, behavior: 'smooth' });
    }

    function afficherHistorique() {
        const body = document.getElementById('hist-body');
        body.innerHTML = "";
        historique.slice().reverse().forEach(item => {
            body.innerHTML += `<tr>
                <td><b>${item.num.toString().padStart(3, '0')}</b></td>
                <td>${item.date}</td>
                <td>${item.locataire}</td>
                <td>
                    <span class="action-link link-print" onclick="reimprimer(${item.id})">üñ®Ô∏è</span>
                    <span class="action-link link-edit" onclick="modifier(${item.id})">‚úé</span>
                    <span class="action-link link-del" onclick="supprimer(${item.id})">üóë</span>
                </td>
            </tr>`;
        });
    }

    function reimprimer(id) {
        const item = historique.find(i => i.id === id);
        if(item) remplirRecu(item);
    }

    function modifier(id) {
        const item = historique.find(i => i.id === id);
        if(item) {
            document.getElementById('proprio').value = item.proprio;
            document.getElementById('locataire').value = item.locataire;
            document.getElementById('adresse').value = item.adresse;
            document.getElementById('montant').value = item.montant;
            document.getElementById('mois').value = item.mois;
            document.getElementById('checkRep').checked = item.estRep;
            toggleRep();
            historique = historique.filter(i => i.id !== id);
            localStorage.setItem('quittance_final_v2', JSON.stringify(historique));
            afficherHistorique();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }

    function supprimer(id) {
        if(confirm("Supprimer ?")) {
            historique = historique.filter(i => i.id !== id);
            localStorage.setItem('quittance_final_v2', JSON.stringify(historique));
            afficherHistorique();
        }
    }
</script>
</body>
</html>
